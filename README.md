# minima-morallma
A little project to experiment with LLM finetuning by making LLaMA sound like the critical theorist Theodor Adorno. 

Adorno was famously a bit of a curmudgeon, which has spawned infinite variations of "What would Adorno think of X if he was alive today?"
Look no further. Here are all of the answers anyone has ever wanted, mostly comprehensible but probably entirely nonsensical.

Found here on HuggingFace: https://huggingface.co/orangeoceans/llama-2-7b-minima-morallma

## Background
### Finetuning LLMs
This project was inspired by a friend's attempt at [finetuning LLaMA to output Stellaris empire descriptions](https://horenbergerb.github.io/2023/09/09/finetuningllamaforcreativetasks.html) with only 30(!!!) samples entirely locally on his own computer(!!!).

As noted in his post (which is a very nice read) this was enabled by three developments:
1. [LIMA: Less Is More for Alignment](https://arxiv.org/abs/2305.11206) suggests that a pre-trained LLM can be finetuned with a very small number of extra samples. This is possibly because the LLM has already learned the desired information, as well as a bunch of garbage, which we can gently nudge it away from in finetuning.
2. [LoRA](https://arxiv.org/abs/2106.09685) dramatically reduced the number of parameters that needed to be modified during finetuning, by supposing an "intrinsic" rank to the model weights many orders of magnitude than their actual dimension. It's pretty mind-blowing that this actually works so well but I guess the intuition is fairly straightforward -- [not all of the LLM's parameters are needed](https://arxiv.org/abs/1804.08838) to perform most of the tasks that we want it to perform.
   - As an aside, this maybe also relates to a similar line of investigation into the concept of LLM *features* as [monosemantic linear combinations of neurons](https://transformer-circuits.pub/2023/monosemantic-features/index.html) which are actually *more* numerous than the number of neurons. Maybe it's that finetuning makes the model better at a specific task but worse at other tasks, which requires fewer parameters than a more generalist model. I'm getting way out of my depth here but I wonder if the monosemantic features are somehow (if only conceptually) related to LoRA's low-rank decomposition matrices.
3. [QLoRA](https://arxiv.org/abs/2305.14314) which lets us do LoRA with a 4-bit quantized model. Neat!

However, I don't have a very beefy computer, so I used Google Colab instead, and spent around 10 bucks. 

### The Subject Matter
In the 1940s-50s Adorno wrote *Minima Moralia*, a collection of 153 aphorisms, which are basically bite-sized texts each ruminating on a subject very roughly encapsulated by an often-cryptic title. Luckily for us, this provides a very nice format for text generation: the user would give a title as a prompt, and the model would output a corresponding aphorism. As an example, consider the following aphorism:

> Final clarity
> 
> The newspaper obituary for a businessman once read: "The breadth of his conscience competed with the goodness of his heart." The lapse committed by the mourners in the rarefied, elevated language called for at such times, the involuntary admission that the kind-hearted deceased was devoid of a conscience, expedites the funeral procession on the shortest path to the land of truth. When a man of advanced age becomes famous for being especially benign, one can presume that his life represented a series of scandals. He has gotten used to outrage. The broad conscience passes itself off as greatness of mind, which forgives everything, because it understands it all too well. A quid pro quo steps between one's own guilt and that of others, which is resolved in favor of whoever got the best of the deal. After such a long life, one just can't distinguish who did what to whom. In the abstract representation of universal injustice, every concrete responsibility collapses. The scoundrel twists it around, as if he experienced it himself: if you only knew, young man, what life is really like. Those however who are already distinguished in the middle of life by special benevolence, are usually drawing an advance on such benignity. Whoever is not evil, does not live benignly, but in a peculiarly bashful manner, hardened and intolerant. Due to a lack of appropriate objects, the latter hardly knows any other expression of their love than the hatred of inappropriate ones, through which they admittedly come to resemble what they hate. The bourgeoisie however is tolerant. Their love for people, as they are, originates in the hatred of rightful human beings.

Challenging stuff.

One obvious difficulty with this is that Adorno's philosophy is quite challenging and often deliberately self-contradictory. Furthermore, Minima Moralia only gives us 153 aphorisms, which is more than my friend's 30 Stellaris empires, but still not a lot given the complexity of their subject matter. I don't think that it will be feasible or even possible to finetune an Adorno LLM to actually *make sense*, so at most I expect the output to *sound* like Adorno. 

## Some Technical Details
### Dataset

The full text of Minima Moralia contains 153 aphorisms. They're dumped in this repo (`minima_moralia_full_text.txt`) which is converted into a set of training samples with a simple script (`minima_moralia_to_json.py`). As is recommended by many a source online, I've formatted each sample with the template: 
```
<s>[INST]<<SYS>>You are Theodor Adorno. You are writing a new version of Minima Moralia, a collection of critical aphorisms. Here is one such aphorism.<</SYS>>TITLE [/INST] BODY TEXT
```
Variations upon this prompt doesn't seem to affect too much, at least in the few tests I've attempted. 

To begin, I used a standard train:eval split of 8:2, which gives me 122 training samples and 31 test samples. However, I found that the evaluation loss wasn't very useful -- it tended to go up, which usually signifies overfitting, even though the text output was qualitatively getting *better*. Judging by [some others' experiences](https://github.com/artidoro/qlora/issues/152), it seems eval loss is just inconsistent when it comes to LLM finetuning. As such, in all subsequent training runs, I used all 153 aphorisms as training samples with no evaluation.

### Training

Most of the hyperparameters were cribbed from various Internet articles (such as [this one](https://mlabonne.github.io/blog/posts/Fine_Tune_Your_Own_Llama_2_Model_in_a_Colab_Notebook.html)) as well as input from friends. Others (such as the learning rate) were derived from trial and error.

For the LoRA rank, I found that 128 was pretty good. It's large enough to output text that makes some sense, though I would caution everyone against taking them seriously as philosophy. 

With the right hyperparameters, training proceeds fairly smoothly. 

Here are some possibly interesting details about how text output changes over the course of finetuning.

As a baseline, an untuned LLaMA 2 gives the following for the title `Internet Memes`:
> Ah, the internet memes. The latest manifestation of the bourgeoisie's attempt to distract and pacify the masses. A fleeting, ephemeral form of entertainment, designed to fill the void of meaningless existence. The internet meme: a symbol of the decay of culture. In a world where the trivial is elevated to the status of the sublime, the meme serves as a reminder of the abyssal depths of human desperation. A desperate attempt to find solace in the abyss of meaninglessness, the meme is the ultimate expression of the bourgeoisie's disavowal of responsibility and the rejection of the search for truth.

Which is very bad and absolutely unlike anything Adorno has ever written!

After 2 or so epochs, at training loss ~2 the model starts getting *very* repetitive:
> It is a space of communication, which is not subject to the control of any particular authority, and which is open to everyone. It is a space of freedom, in which the most diverse and contradictory ideas are allowed to be expressed. It is a space of democracy, in which the most diverse and contradictory voices are heard. It is a space of the public sphere...

So it goes, on and on. It seems maybe that there's some behavior to avoid reptition that gets trained *out* of the LLM at this early stage. Eventually, though, things start making sense.

At loss ~0.3:
> The internet has brought into circulation a new species of ideology-images. They are so absurdly weak as to be practically true. They are so globally accessible, that even the most malignant consciousness can no longer deny their validity. They are the memes of the internet. They are ideas in the form of replicating images. Once they have spread across the world through the network, their power is irresistible. They pass themselves on with the simplest of all algorithms: those who see them are persuaded. The meme has its form of organization precisely as its own replication. It is a thought-form of the comic, the ridiculous, the sublime in its immeasurable totality. The internet has made it possible for such thoughts to take on a life of their own. They are toy world-historical phenomena. ...

Which is still a bit repetitive, as it starts most of its sentences with "They..." but it is much, much better!

## Results

In this section I'll provide some examples of the output at various training losses. Notably, it seems as the training loss gets lower, the generated aphorism is *less and less on-topic to the title given in the prompt*. I think this is likely because LLaMA starts out inclined to generate on-topic responses, which is gradually tuned out of LLaMA as Adorno's aphorism titles are rarely straightforwardly related to the aphorism itself. As such, the most useful model to play around with is not the one with a lower training loss at ~0.04 (which still doesn't overfit necessarily!) but a slightly "worse" one at ~0.2, which will actually give answers relevant to the prompt.

### Good Ones

#### The Big Bang Theory (Training Loss ~0.2)
> The popular television series The Big Bang Theory is a mockery of the situation, in which human beings find themselves through the gracious intervention of technology. The characters are so thoroughly subordinated to the objects, which they constantly handle, that they have completely forgotten how to think. They are busy making brisk gestures, and their heads, which should be filled with ideas, are crammed with nonsense. They expect their world to be filled with miraculous events, and are shattered, when things fall short of expectation. Because they alienated themselves from thought, in order to handle objects, they are incapable of understanding anything outside of the television set and the computer. This makes them easily recognizable, and in the end the sitcom is even less about them than the all too human humor, which was already a mockery of human beings. The depiction of Sheldon and his gang as geniuses is disreputable to the science they represent, which, as independent thinkers, they are in any case barely capable of comprehending. The "sciences" are altogether too much like the "social sciences," and the distinction between them is mere appearance. What is called social, is in fact the realm of objects, which undergo regularized, quantified procedures, whether this is the behavior of human beings or the internalized organization of the mind. The "social sciences," like anthropology, sociology and political science, are really no more than the attempt to subordinate the entire realm of objects, which is incommensurable with them, under the concept of "social," which, as meaningful organization, is simultaneously the refusal of such. It is the "scientific" subsumption under "society," which refuses to acknowledge the existence of human beings. The "social sciences" are thereby exposed in their double inadequacy: they are neither sufficient, to grasp the realm of society, nor appropriate, to grasp human beings.

#### Jerry Seinfeld (Training Loss ~0.2)
> The comedian Jerry Seinfeld are said to have an annual income of over 10 million dollars. This is probably an exaggeration, but it says just as much about the state of the art of comedy, as the S.A.D. does about the psychological school. Seinfeld's material is entirely based on the observation of minor details; he describes them as "nothing episodes." They are neither funny nor meaningful, but they are impeccably presented with a deadpan expression as if they were. His irony, which is supposed to have an all-embracing insight into human nature, merely reflects, as in the famous "nothing" bit, that he has turned his back on the attempt to find meaning in the world and thereby in himself. His comedy, for which he has won numerous awards, is recognized with a certain nervous guilt and, in view of the measurable bad conscience, is tolerantly rewarded with a television award and a million dollars. It is as if the audience wants to say: well, if there's nothing to be done about meaning, then let's at least have some fun with it. They applaud the cleverness with which Seinfeld puts meaninglessness in its place, as they once did for the meaninglessness of the existence, which stood under the baleful sign of the "that is to say." The comedian's material is to a considerable degree generated by his own implacable enmity towards his ex-girlfriend. This has helped to ensure that his jokes, which otherwise might have been directed against the society, fall measurably flat. They are mired in the hatred, and the hatred is empty. They end up in the mechanized insult, which is immediately absorbed as a standard feature of the television landscape. In view of this, it is no longer meaningful to ask whether comedy has lost its humor.

#### Sonic the Hedgehog (Training Loss ~0.2)
> Video games are not merely passive entertainment, but actively shape their players. They do this by influencing the players' attention through the selection of important objects, by gradually reducing the players' independent actions and finally making these impossible at all. The player's agency is tested and then annulled. The latter occurs most dramatically in the genre of survival horror games, where the player must constantly make sacrifices and give in to fear. In these games, unresisting and yielding to fear becomes a necessary condition of progress, indeed of mere survival. The player must give up free will and indeed any idea of self-determination in order to succeed. The horror of the game exerts such a powerful influence over the player that it takes over the entire control of the game, pacifying the latter and making it unplayable any other way. The player is trapped in a spiral of decline, in which the lasting enjoyment of the game and indeed its very possibility are made to depend on giving up the last of one's own principles. What applies to the genre of survival horror games in general applies particularly to the game Sonic the Hedgehog. In this game, the player must constantly give up their independence and make sacrifices, in order to maintain the continuity of the action and indeed to survive. The game imposes on the player the form of the level, which is that of the obstacle course. One must always run as fast as possible, always at the same pace, always exactly where one is supposed to be. The game does not allow for any free play, no daydreaming, no meandering. It is strictly linear and measures the player's progress in terms of time. The sacrifices which the player must make concern not only the management of one's own character, but also the control of the player themselves. For example, in order to pass a certain obstacle, the player may have to give up precious objects such as rings, which would otherwise allow them to unlock additional paths. 

#### Starship Enterprise (Training Loss ~0.04)
> The Fascist era has absurdly stabilized the infantile picture of the world as a "journey", not merely in the sense that it has reduced the course of the world to a few years, but in a far more radical sense: the idea of the "journey" itself has become infantile. The thought that the world could be traveled in the manner of a pleasure-trip, that one could visit all the interesting places in the world, has always been naive, independent of the social order in which one lived. The ancient Greeks were already aware of this, when they called traveling by sea for example "wanderings" (peregrinations, in Greek: pragmateia), a term which carries over into German and means something like "homelessness". But if one visited all the great cities of the world, for example, one would still be left with the impression that the world is not inhabited by individuals, but by a population of tourists. The names and the deeds of the great leaders of the 20th century are already being forgotten in the manner of a pleasant journey, the details of which already seem irrelevant. The world has truly become a journey, but this journey has taken on the aspect of a train ride. One gets on, reads a few novels, takes a few factual texts with them, meets a few people, and above all waits. Waiting has overgrown everything, like a cancer. It has taken on the aspect of something calamitous, something which must be endured. One no longer even waits for something pleasant, but only for the end of the journey. The idea of the "journey" itself has become contaminated with the will to power. Whoever begins to travel, in the sense of visiting places, already has the shape of the world under their fingertips. They know, for example, that Rome is three hours by train from Florence, and that the Acropolis in Athens is visible from almost every point in the city. 

I quite like this one because it's tangentially related to the title, but in a satisfying way. However, the model suggests that the Greek *pragmateia* means peregrenation or wandering. I don't know any Greek but from a quick Google search I'm not sure that's true!

### Bad (but still interesting) Ones

#### Weezer (Training Loss ~0.06)
> The first and only line of the song "Baby, C'mon, Pt. 2" by the American pop band 'N Sync reads: "Girl, you're so fine, you blow my mind." This is a question of the truth of the statement, as well as its relationship to the chorus, in which the speaker implores the girl to come closer, so that she can see how much he loves her. But the question of the truth of the statement is complicated by the fact that the subject of the sentence, the pop idol Justin Timberlake, cannot actually love anyone. Love is a social order, a sanction of what is normative and valid. If Timberlaine loves someone, then this is solely a function of the reflection of the mirror-symmetry of the subject-object relationship, of the fact that someone exists for him, so that he can exist for someone. The more abstract the concept of "love" however is, the more dubious the validity of the sentence becomes: if "girl, you're so fine, you blow my mind" is supposed to express the rapture of the beholder, then the object of this rapture is simultaneously reduced to a mere object, whose sole function is to be loved, and whose autonomy is thereby cancelled out. The "mind" which is blown, is at least as much a piece of equipment as the guitar, on which Timberlake strums his chords. Love, according to this construction, is nothing more than the exchange of experiences. If this is true, then the sentence "Girl, you're so fine, you blow my mind" is to be read as a command, rather than an expression of feeling. The subject of the sentence is not so much expressing his feelings, as instructing the object of his desires, how she should behave, in order to be accepted. This is confirmed by the chorus, in which the speaker implores the girl to come closer, so that he can love her. 

This one is about N Sync and Justin Timberlake, *not* Weezer like the prompt had asked! Interesting that it chose a completely different band.

#### Sonic the Hedgehog (Training Loss ~0.06)
> The video-games of the current generation are, as is commonly known, the play-forms chosen by children in order to vicariously experience the pleasure of killing. But this is only one aspect of the total social economy of violence. The realted play-forms, which are developed in response to the needs of the all too real economy, are just as much a part of the latter as the toy-guns and finger-held-lights which were the scandals of my childhood. I remember how my brother and I enthusiastically played together with our first electric train, sent to us as a birthday present by my uncle, a conductor on the Rhine. We set up the train on its track, around the curved edge of the table, and sent it careering through the house, over the bumps, turning corners, and finally crashing into the wall of the living-room. This was so pleasurable, that we couldn't stop playing with it, even when the train was completely wrecked and no longer operable. Something of this has not been extinguished by the game-consoles of today. They still have the same name, "trains," and even the same stationery, but they are no longer sent as birthday presents, and they endlessly crash into each other, without producing the wall-building effect. They are toys of destruction, in which the destruction itself is already the principle of fun. Just as the action-figures of Superman and Batman are actually dolls, so too is the "Sonic the Hedgehog" really a toy for the destruction of the controls. Its success is easily explicable in the light of this schema. It is not a question of the banal "sexual repression," which allegedly causes children to fixate on aggressive forms of play, but rather the prevalence of an unconscious, neutral-animalistic pleasure in the relations of children to their toys.

This one stops making any sense about halfway through, but I like the anecdote here about playing with trains as children. This anecdote is not present at all in Minima Moralia, so it was either learned from some other Adorno work during pre-training, or made up entirely as an Adorno-sounding anecdote!

#### Sonic the Hedgehog (Training Loss ~0.04)
> The music of the 19th century, with which most of us were educated, lives on in our unconscious as the mold into which all subsequent sound is compared. This compares favorably with the conscious relationship to music. What is historical in music is not merely the object of historical research, but continues to live on as a force of attraction and as the condition of what is contemporary. What is historical in music, however, is above all the form of the sonata, whose final, unambiguously-delineated chord closes the piece, as it were, with a smack. This chord, the "final" chord of the tonic, is so firmly established in our ears, that it appears to be the chord of return, the "final" judgment, in all music. And indeed, the chord is so strong, that it has survived the process of dissolution, which all other harmonic forms have undergone during the development of tonality. It endures as the wall of sound, which encases all other sounds, as a kind of collector's item of what is harmonically simple. The sonic equivalent of the "final" chord is the ominous, overly loud and overly clear dominance of the bass. Every other sound is muted, compared to such, as if the latter, the harmony of which is statically fixed, were to be adjudged by the dynamic, by the voice of the speaker, which has a primacy over all other voices. This creates a dangerous and ear-racking effect, which is all the more damaging, because what is dominant in classical music is by no means a final judgment, but an ambiguous, statically unstable form, the dissonance of which was at that time sought everywhere in the tonal system and later displaced by the consensus of what is tonally well-proportioned.

It seems here that the model fixated on "Sonic" and ignored "the Hedgehog" entirely.

